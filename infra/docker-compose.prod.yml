version: "3.8"

# Production Docker Compose for PreviewCloud Infrastructure

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.2
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Dashboard (secure with basic auth)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik-certificates:/letsencrypt
      - traefik-logs:/var/log/traefik
    networks:
      - previewcloud
    labels:
      - "traefik.enable=true"
      # Dashboard (optional - for monitoring)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.previewcloud.cloud`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      # Basic auth for dashboard (generate with: htpasswd -nb admin password)
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$8kd94yns$$0JvUhFdFXk7vsP8qEKQsV."
      # Default password is "admin" - CHANGE THIS IN PRODUCTION!

  # MongoDB (Platform database - stores users, previews metadata)
  mongodb-platform:
    image: mongo:7
    container_name: mongodb-platform
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: previewcloud
    volumes:
      - mongodb-platform-data:/data/db
      - mongodb-platform-config:/data/configdb
    ports:
      - "127.0.0.1:27017:27017" # Only accessible from localhost
    networks:
      - previewcloud
    command: mongod --auth

  # PostgreSQL (For preview databases)
  postgres:
    image: postgres:15
    container_name: postgres-previews
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432" # Only accessible from localhost
    networks:
      - previewcloud
    command: postgres -c max_connections=200

  # MySQL (For preview databases)
  mysql:
    image: mysql:8
    container_name: mysql-previews
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "127.0.0.1:3306:3306" # Only accessible from localhost
    networks:
      - previewcloud
    command: --default-authentication-plugin=mysql_native_password --max_connections=200

  # MongoDB (For preview databases)
  mongodb-previews:
    image: mongo:7
    container_name: mongodb-previews
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_PREVIEW_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PREVIEW_PASSWORD}
    volumes:
      - mongodb-previews-data:/data/db
    ports:
      - "127.0.0.1:27018:27017" # Only accessible from localhost
    networks:
      - previewcloud
    command: mongod --auth

  # Redis (For caching and queues)
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379" # Only accessible from localhost
    networks:
      - previewcloud

  # PreviewCloud Backend API
  previewcloud-api:
    build:
      context: ../backend
      dockerfile: Dockerfile.prod
    container_name: previewcloud-api
    restart: unless-stopped
    env_file:
      - ../backend/.env
    environment:
      NODE_ENV: production
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # For Docker API access
      - preview-builds:/tmp/builds
      - ../backend/logs:/app/logs
    networks:
      - previewcloud
    labels:
      - "traefik.enable=true"
      # API routing - HTTP (for ACME challenge)
      - "traefik.http.routers.api-http.rule=Host(`api.previewcloud.cloud`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=redirect-to-https"
      # API routing - HTTPS
      - "traefik.http.routers.api.rule=Host(`api.previewcloud.cloud`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=3001"
      # Apply middlewares
      - "traefik.http.routers.api.middlewares=secure-headers,rate-limit,compress"
      # Redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    depends_on:
      - mongodb-platform
      - postgres
      - mysql
      - mongodb-previews
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Grafana (Monitoring Dashboard)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "127.0.0.1:3000:3000"
    networks:
      - previewcloud
    labels:
      - "traefik.enable=true"
      # Grafana HTTP (for ACME challenge)
      - "traefik.http.routers.grafana-http.rule=Host(`monitoring.previewcloud.cloud`)"
      - "traefik.http.routers.grafana-http.entrypoints=web"
      - "traefik.http.routers.grafana-http.middlewares=redirect-to-https"
      # Grafana HTTPS
      - "traefik.http.routers.grafana.rule=Host(`monitoring.previewcloud.cloud`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # Prometheus (Metrics Collection)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    networks:
      - previewcloud

networks:
  previewcloud:
    name: previewcloud
    driver: bridge

volumes:
  traefik-certificates:
    driver: local
  traefik-logs:
    driver: local
  mongodb-platform-data:
    driver: local
  mongodb-platform-config:
    driver: local
  mongodb-previews-data:
    driver: local
  postgres-data:
    driver: local
  mysql-data:
    driver: local
  redis-data:
    driver: local
  preview-builds:
    driver: local
  grafana-data:
    driver: local
  prometheus-data:
    driver: local
